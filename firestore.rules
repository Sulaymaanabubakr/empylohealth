rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    function isCircleMember(circleId, uid) {
      return (
        exists(/databases/$(database)/documents/circles/$(circleId)/members/$(uid)) &&
        get(/databases/$(database)/documents/circles/$(circleId)/members/$(uid)).data.status == 'active'
      ) || (
        exists(/databases/$(database)/documents/circles/$(circleId)) &&
        get(/databases/$(database)/documents/circles/$(circleId)).data.members is list &&
        uid in get(/databases/$(database)/documents/circles/$(circleId)).data.members
      );
    }

    function isCircleModerator(circleId, uid) {
      return isCircleMember(circleId, uid) &&
        get(/databases/$(database)/documents/circles/$(circleId)/members/$(uid)).data.role in ['creator', 'admin', 'moderator'];
    }

	    function sharedCircleReadAllowed(targetUid) {
	      // Firestore rules do not support statements (if/let); keep this expression-only.
	      return isAuthenticated() &&
	        exists(/databases/$(database)/documents/userCircles/$(request.auth.uid)) &&
	        exists(/databases/$(database)/documents/userCircles/$(targetUid)) &&
	        get(/databases/$(database)/documents/userCircles/$(request.auth.uid)).data.circleIds is list &&
	        get(/databases/$(database)/documents/userCircles/$(targetUid)).data.circleIds is list &&
	        get(/databases/$(database)/documents/userCircles/$(request.auth.uid)).data.circleIds
	          .hasAny(get(/databases/$(database)/documents/userCircles/$(targetUid)).data.circleIds);
	    }

    function circleMembershipOnlyUpdate() {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly([
        'members',
        'membersCount',
        'updatedAt'
      ]);
    }

    function isSafeSelfJoin() {
      return request.auth.uid in request.resource.data.members &&
        !(request.auth.uid in resource.data.members) &&
        request.resource.data.members.size() == resource.data.members.size() + 1;
    }

    function isSafeSelfLeave() {
      return !(request.auth.uid in request.resource.data.members) &&
        request.auth.uid in resource.data.members &&
        request.resource.data.members.size() + 1 == resource.data.members.size();
    }

    match /users/{userId} {
      allow read: if isAuthenticated() && (isSelf(userId) || sharedCircleReadAllowed(userId));
      allow create: if isSelf(userId) && request.resource.data.uid == request.auth.uid;
      allow update: if isSelf(userId) &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if isSelf(userId) || isAdmin();
    }

    match /userCircles/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create, update: if isSelf(uid) &&
        request.resource.data.keys().hasOnly(['circleIds', 'updatedAt']) &&
        request.resource.data.circleIds is list;
      allow delete: if false;
    }

    match /circles/{circleId} {
      allow read: if isAuthenticated() && (
        resource.data.type == 'public' ||
        (resource.data.members is list && request.auth.uid in resource.data.members) ||
        isCircleMember(circleId, request.auth.uid)
      );
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid &&
        request.resource.data.adminId == request.auth.uid &&
        request.resource.data.members is list &&
        request.auth.uid in request.resource.data.members;
      allow update: if isCircleModerator(circleId, request.auth.uid) ||
        (isAuthenticated() && circleMembershipOnlyUpdate() && (isSafeSelfJoin() || isSafeSelfLeave()) && resource.data.type == 'public');
      allow delete: if isCircleModerator(circleId, request.auth.uid);

      match /members/{memberId} {
        allow read: if isCircleMember(circleId, request.auth.uid);
        allow create: if isSelf(memberId) || isCircleModerator(circleId, request.auth.uid);
        allow update: if isSelf(memberId) || isCircleModerator(circleId, request.auth.uid);
        allow delete: if isCircleModerator(circleId, request.auth.uid);
      }

      match /requests/{userId} {
        allow create: if isSelf(userId);
        allow read: if isSelf(userId) || isCircleModerator(circleId, request.auth.uid);
        allow update, delete: if isCircleModerator(circleId, request.auth.uid);
      }

      match /reports/{reportId} {
        allow create: if isCircleMember(circleId, request.auth.uid);
        allow read, update: if isCircleModerator(circleId, request.auth.uid);
        allow delete: if false;
      }

      match /scheduledHuddles/{eventId} {
        allow read: if isCircleMember(circleId, request.auth.uid);
        allow write: if isCircleModerator(circleId, request.auth.uid);
      }

      match /messages/{messageId} {
        allow read: if isCircleMember(circleId, request.auth.uid);
        allow create: if isCircleMember(circleId, request.auth.uid) && request.resource.data.senderId == request.auth.uid;
        allow update, delete: if false;
      }
    }

    match /chats/{chatId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() &&
        request.resource.data.type == 'direct' &&
        request.resource.data.participants is list &&
        request.resource.data.participants.size() == 2 &&
        request.auth.uid in request.resource.data.participants;
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.participants &&
        request.resource.data.participants == resource.data.participants &&
        request.resource.data.type == resource.data.type &&
        request.resource.data.directKey == resource.data.directKey;
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow create: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
          request.resource.data.senderId == request.auth.uid;
        allow update, delete: if false;
      }
    }

    match /resources/{resourceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /challenges/{challengeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /affirmations/{affirmationId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /contactMessages/{messageId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    match /subscriptionPlans/{planId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /huddles/{huddleId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow write: if false;
    }

    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.uid == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.uid == request.auth.uid;
      allow delete: if false;
    }

    match /learningSessions/{sessionId} {
      allow read: if isAuthenticated() && resource.data.uid == request.auth.uid;
      allow create, update: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow delete: if false;
    }

    match /campaigns/{campaignId} {
      allow read: if isAuthenticated() && resource.data.uid == request.auth.uid;
      allow create, update: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow delete: if false;
    }

    match /assessments/{assessmentId} {
      allow read: if isAuthenticated() && resource.data.uid == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if false;
    }

    match /assessment_questions/{questionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
